{% extends "master.html" %}
{% load static %}
{% block title %}Donor Dashboard{% endblock %}
{% block content %}

<style>
  /* Simple red alert styling */
  .alert-box {
      background-color: #ffdddd;
      color: #b30000;
      padding: 10px 15px;
      border-left: 4px solid #b30000;
      border-radius: 4px;
      margin-bottom: 10px;
      margin-top: 20px;
      display: none;
      font-size: 15px;
  }

  /* Fade-out transition */
  .fade-out {
      opacity: 0;
      transition: opacity 1s ease-out;
  }

  /* Disable card click */
  .disabled-card {
      pointer-events: none;
      opacity: 0.5;
  }
</style>


<div class="hospital-dashboard">


  <!-- Header -->
  <div class="dashboard-header">
    <div class="welcome-text">
      <h2>Welcome, {{ request.user.username|title }}</h2>
      <p>Manage your blood donation activities and appointments efficiently.</p>
    </div>

    <div class="header-right">
      <!-- Notification Bell -->
      <div class="position-relative me-3">
        <a href="{% url 'notifications' %}" class="text-decoration-none text-danger">
          <i class="fa fa-bell fa-lg"></i>
          {% if unread_count > 0 %}
          <span class="notif-badge">{{ unread_count }}</span>
          {% endif %}
        </a>
      </div>

      <!-- Profile Dropdown -->
      <div class="dropdown">
        {% if donor.profile_pic %}
        <img src="{{ donor.profile_pic.url }}" alt="Profile Picture" class="hospital-logo" id="logoDropdown"
          onclick="toggleDropdown()" />
        {% else %}
        <i class="fas fa-user-circle profile-icon" id="logoDropdown" onclick="toggleDropdown()"></i>
        {% endif %}

        <ul class="custom-dropdown shadow" id="dropdownMenu">
          <li><a href="{% url 'donor_profile' %}"><i class="fas fa-user me-2"></i> Profile</a></li>
          <li><hr></li>
          <li>
            <a href="#" class="text-danger" onclick="confirmLogout(event)">
              <i class="fas fa-sign-out-alt me-2"></i> Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
     <!-- Alert Message -->
  <div id="msgAlert" class="alert-box"></div>

  <!-- Dashboard Cards -->
  <div class="hospital-cards">

    <!-- Appointment Card with JS protection -->
    <a href="#" onclick="checkStatus(event)" class="hosp-card" id="appointmentCard">
      <i class="fas fa-calendar-check"></i>
      <h4>Appointment Request</h4>
      <p>Answer quick health questions and submit a donation request.</p>
    </a>

    <a href="{% url 'donation_history' %}" class="hosp-card">
      <i class="fas fa-book"></i>
      <h4>Donation History</h4>
      <p>View your past donations.</p>
    </a>

    <a href="{% url 'donor_camp' %}" class="hosp-card">
      <i class="fas fa-hand-holding-heart"></i>
      <h4>Camps</h4>
      <p>See upcoming nearby donation camps.</p>
    </a>

  </div>

</div>

<!-- JS -->
<script>
  const donorStatus = "{{ donor_status }}";  
  // donor_status passed from view: "allowed", "pending", "sent", "accepted", "wait_3_months"

  const msgBox = document.getElementById("msgAlert");

  function showMessage(message) {
      msgBox.innerText = message;
      msgBox.style.display = "block";

      // Auto-hide after 3 seconds
      setTimeout(() => {
          msgBox.classList.add("fade-out");
          setTimeout(() => {
              msgBox.style.display = "none";
              msgBox.classList.remove("fade-out");
          }, 1000);
      }, 3000);
  }

  function checkStatus(event) {
      if (donorStatus === "allowed") {
          window.location.href = "{% url 'donor_appoinment' %}";
      } else if (donorStatus === "pending") {
          showMessage("You already have a pending appointment request.");
      } else if (donorStatus === "sent") {
          showMessage("You have a request waiting for admin review.");
      } else if (donorStatus === "accepted") {
          showMessage("Your last donation request was accepted. Please complete the process.");
      } else if (donorStatus === "wait_3_months") {
          showMessage("You have already donated. You can request again after 3 months.");
      }
      event.preventDefault();
  }

  // Profile dropdown
  function toggleDropdown() {
    const dropdown = document.getElementById("dropdownMenu");
    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
  }

  document.addEventListener("click", function (event) {
    const dropdown = document.getElementById("dropdownMenu");
    const logo = document.getElementById("logoDropdown");
    if (!logo.contains(event.target) && !dropdown.contains(event.target)) {
      dropdown.style.display = "none";
    }
  });

  function confirmLogout(event) {
    event.preventDefault();
    if (confirm("Are you sure you want to logout?")) {
      window.location.href = "{% url 'logout' %}";
    }
  }
</script>

{% endblock %}
